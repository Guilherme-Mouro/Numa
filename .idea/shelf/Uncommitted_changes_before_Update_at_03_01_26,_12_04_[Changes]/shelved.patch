Index: app/src/main/java/com/example/numa/fragment/ShopFragment.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.numa.fragment\n\nimport android.os.Bundle\nimport androidx.fragment.app.Fragment\nimport android.view.LayoutInflater\nimport android.view.View\nimport android.view.ViewGroup\nimport android.widget.ImageView\nimport android.widget.TextView\nimport android.widget.Toast\nimport androidx.lifecycle.lifecycleScope\nimport androidx.recyclerview.widget.LinearLayoutManager\nimport androidx.recyclerview.widget.RecyclerView\nimport com.example.numa.R\nimport com.example.numa.UserRepository\nimport com.example.numa.adapter.ShopItemAdapter\nimport com.example.numa.databinding.FragmentShopBinding\nimport com.example.numa.entity.ShopItem\nimport com.example.numa.entity.UserItem\nimport com.example.numa.util.DatabaseProvider\nimport com.example.numa.util.SessionManager\nimport com.google.android.material.dialog.MaterialAlertDialogBuilder\nimport kotlinx.coroutines.launch\n\nclass ShopFragment : Fragment() {\n    private var _binding: FragmentShopBinding? = null\n    private val binding get() = _binding!!\n    private val db by lazy { DatabaseProvider.getDatabase(requireContext()) }\n\n    private lateinit var types: Map<String, RecyclerView>\n\n    override fun onCreateView(\n        inflater: LayoutInflater,\n        container: ViewGroup?,\n        savedInstanceState: Bundle?\n    ): View {\n        _binding = FragmentShopBinding.inflate(inflater, container, false)\n\n        val sessionManager = SessionManager(requireContext())\n        val userId = sessionManager.getUserId()\n\n        if (userId == null) {\n            Toast.makeText(requireContext(), \"Error: user not found\", Toast.LENGTH_SHORT).show()\n            return binding.root\n        }\n\n        types = mapOf(\n            \"skin\" to binding.rvShopItemsSkins,\n            \"head\" to binding.rvShopItemsHead,\n            \"torso\" to binding.rvShopItemsTorso,\n            \"legs\" to binding.rvShopItemsLegs,\n            \"feet\" to binding.rvShopItemsFeet,\n            \"background\" to binding.rvShopItemsBackground\n        )\n\n        loadShopItems(userId)\n\n        return binding.root\n    }\n\n    private fun loadShopItems(userId: Int) {\n        lifecycleScope.launch {\n            val ownedItemIds = db.userItemDao()\n                .getUserItemByUserId(userId)\n                .map { it.itemId }\n                .toSet()\n\n            val pet = db.petDao().getPetByUser(userId)\n\n            types.forEach { (type, recyclerView) ->\n                val shopItems = db.shopItemDao().getShopItemByType(type)\n\n                val currentEquippedValue = when(type) {\n                    \"skin\" -> pet?.skin; \"head\" -> pet?.head; \"torso\" -> pet?.torso\n                    \"legs\" -> pet?.legs; \"feet\" -> pet?.feet\n                    else -> null\n                }\n\n                val equippedId = shopItems.find { it.item == currentEquippedValue }?.id\n\n                setupCategoryList(recyclerView, shopItems, userId, ownedItemIds, equippedId)\n            }\n        }\n    }\n\n    private fun setupCategoryList(\n        recyclerView: RecyclerView,\n        shopItems: List<ShopItem>,\n        userId: Int,\n        ownedItemIds: Set<Int>,\n        equippedId: Int?\n    ) {\n        recyclerView.apply {\n            layoutManager = LinearLayoutManager(requireContext(), LinearLayoutManager.HORIZONTAL, false)\n            adapter = ShopItemAdapter(\n                shopItems = shopItems.toMutableList(),\n                ownedItemIds = ownedItemIds,\n                equippedItemId = equippedId\n            ) { shopItem ->\n                showActionDialog(shopItem, userId)\n            }\n        }\n    }\n\n    private fun showActionDialog(shopItem: ShopItem, userId: Int) {\n        lifecycleScope.launch {\n            val isOwned = db.userItemDao().getUserItemByUserId(userId).any { it.itemId == shopItem.id }\n\n            val dialogView = layoutInflater.inflate(R.layout.item_custom_dialog, null)\n            val imgItem = dialogView.findViewById<ImageView>(R.id.imgDialogItem)\n            val tvName = dialogView.findViewById<TextView>(R.id.tvDialogName)\n            val tvPrice = dialogView.findViewById<TextView>(R.id.tvDialogPrice)\n\n            tvName.text = shopItem.name\n            tvPrice.text = if (isOwned) \"Owned\" else \"${shopItem.price} Points\"\n\n            val imageResource = requireContext().resources.getIdentifier(\n                shopItem.image, \"drawable\", requireContext().packageName\n            )\n            imgItem.setImageResource(imageResource)\n\n            val dialog = MaterialAlertDialogBuilder(requireContext())\n                .setView(dialogView)\n                .setNegativeButton(\"Cancel\", null)\n                .setPositiveButton(if (isOwned) \"Equip\" else \"Buy\") { _, _ ->\n                    if (isOwned) equipItem(shopItem, userId) else processPurchase(shopItem, userId)\n                }\n                .create()\n\n            dialog.window?.setBackgroundDrawableResource(android.R.color.transparent)\n            dialog.show()\n        }\n    }\n\n    private fun equipItem(shopItem: ShopItem, userId: Int) {\n        lifecycleScope.launch {\n            val pet = db.petDao().getPetByUser(userId) ?: return@launch\n\n            when (shopItem.type) {\n                \"skin\" -> db.petDao().updateSkin(pet.id, shopItem.item)\n                \"head\" -> db.petDao().updateHead(pet.id, shopItem.item)\n                \"torso\" -> db.petDao().updateTorso(pet.id, shopItem.item)\n                \"legs\" -> db.petDao().updateLegs(pet.id, shopItem.item)\n                \"feet\" -> db.petDao().updateFeet(pet.id, shopItem.item)\n            }\n\n            val recyclerView = types[shopItem.type]\n            val adapter = recyclerView?.adapter as? ShopItemAdapter\n            adapter?.updateEquippedItem(shopItem.id)\n\n            Toast.makeText(requireContext(), \"${shopItem.name} Equipped!\", Toast.LENGTH_SHORT).show()\n        }\n    }\n\n    private fun processPurchase(shopItem: ShopItem, userId: Int) {\n        lifecycleScope.launch {\n            val user = db.userDao().getUserById(userId) ?: return@launch\n\n            if (user.points >= shopItem.price) {\n                db.userItemDao().insertUserItem(UserItem(userId = userId, itemId = shopItem.id))\n\n                UserRepository(db.userDao()).addXpAndPoints(userId, 0, -shopItem.price)\n\n                val recyclerView = types[shopItem.type]\n                (recyclerView?.adapter as? ShopItemAdapter)?.markItemAsOwned(shopItem.id)\n\n                Toast.makeText(requireContext(), \"Bought!\", Toast.LENGTH_SHORT).show()\n            } else {\n                Toast.makeText(requireContext(), \"Not enough points!\", Toast.LENGTH_SHORT).show()\n            }\n        }\n    }\n\n    override fun onDestroyView() {\n        super.onDestroyView()\n        _binding = null\n    }\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/example/numa/fragment/ShopFragment.kt b/app/src/main/java/com/example/numa/fragment/ShopFragment.kt
--- a/app/src/main/java/com/example/numa/fragment/ShopFragment.kt	(revision f9694c335f4ace3e7b49f86971a756989be0ddff)
+++ b/app/src/main/java/com/example/numa/fragment/ShopFragment.kt	(date 1766749868266)
@@ -12,13 +12,13 @@
 import androidx.recyclerview.widget.LinearLayoutManager
 import androidx.recyclerview.widget.RecyclerView
 import com.example.numa.R
-import com.example.numa.UserRepository
 import com.example.numa.adapter.ShopItemAdapter
 import com.example.numa.databinding.FragmentShopBinding
 import com.example.numa.entity.ShopItem
 import com.example.numa.entity.UserItem
 import com.example.numa.util.DatabaseProvider
 import com.example.numa.util.SessionManager
+import com.example.numa.util.UserRepository
 import com.google.android.material.dialog.MaterialAlertDialogBuilder
 import kotlinx.coroutines.launch
 
